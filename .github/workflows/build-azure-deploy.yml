name: Build, Scan, and Deploy

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.08.24
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Google Container Registry
      uses: google-github-actions/auth@v0
      with:
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Build and Push Docker image
      run: |
        docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend:${{ github.ref_name }} .
        docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend:${{ github.ref_name }}

    - name: List Docker images
      run: docker image ls

  sonarQubeAnalysis:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Check out the code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: SonarQube Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.organization=vishalsubharthi
          -Dsonar.projectKey=CICD
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  deploy:
    runs-on: ubuntu-latest
    needs: sonarQubeAnalysis  # Ensures the scan job completes before deployment

    steps:
    - name: Set up kubectl
      uses: google-github-actions/setup-gcloud@v0
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}

    - name: Deploy to GKE
      run: |
        kubectl config use-context $(gcloud container clusters list --format "value(name)" --limit 1)
        kubectl set image deployment/backend backend=gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend:${{ github.ref_name }}